<template>
    <div :class="{ 'tainacan-repository-level-colors page-container': isRepositoryLevel }">
        
        <tainacan-title :is-sticky="true" />
        
        <p v-if="isRepositoryLevel">
            {{ $i18n.get('info_repository_filters_inheritance') }}
        </p>
                        
        <div class="filters-list-page">
            <b-loading
                    v-model="isLoadingMetadatumTypes"
                    :is-full-page="false" />
            
            <div
                    v-if="(isRepositoryLevel && $userCaps.hasCapability('tnc_rep_edit_filters') || (!isRepositoryLevel && collection && collection.current_user_can_edit_filters))"
                    ref="filterEditionPageColumns"
                    :style="{ height: activeFiltersList.length <= 0 && !isLoadingFilters ? 'auto' : 'calc(100% - 6px - ' + columnsTopY + 'px)'}"
                    class="columns is-multiline">
                <div class="column is-12-touch">

                    <div class="tainacan-form sub-header">
                        <h2>{{ $i18n.get('filters') }}</h2>

                        <template v-if="activeFiltersList && activeFiltersList.length > 5 && !isLoadingFilters">
                                
                            <b-field class="header-item">
                                <b-input 
                                        v-model="filterNameFilterString"
                                        :placeholder="$i18n.get('instruction_type_search_filter_filter')"
                                        icon="magnify"
                                        size="is-small"
                                        icon-right="close-circle"
                                        icon-right-clickable
                                        @icon-right-click="filterNameFilterString = ''" />
                            </b-field>
                        </template>
                    </div>

                    <section 
                            v-if="activeFiltersList.length <= 0 && !isLoadingFilters"
                            class="field is-grouped-centered section">
                        <div class="content has-text-gray has-text-centered">
                            <p>
                                <span class="icon is-large">
                                    <i class="tainacan-icon tainacan-icon-36px tainacan-icon-filters" />
                                </span>
                            </p>
                            <p>{{ $i18n.get('info_there_is_no_filter' ) }}</p>  
                            <p>{{ $i18n.get('info_create_filters' ) }}</p>
                        </div>
                    </section>

                    <sortable
                            :list="activeFiltersList"
                            item-key="id"
                            class="active-filters-area"
                            :class="{ 'filters-area-receive': isDraggingFromAvailable }"
                            :options="{
                                group: { name:'filters', pull: false, put: true },
                                sort: (openedFilterId == '' || openedFilterId == undefined) && !isRepositoryLevel,
                                handle: '.handle',
                                hostClass: 'sortable-ghost',
                                filter: '.not-sortable-item',
                                preventOnFilter: false,
                                animation: 250
                            }"
                            @update="handleChangeOnFilter"
                            @add="handleChangeOnFilter" 
                            @remove="handleChangeOnFilter">
                        <template #item="{ element: filter, index }">
                            <div
                                    v-show="filterNameFilterString == '' || filter.name.toString().toLowerCase().indexOf(filterNameFilterString.toString().toLowerCase()) >= 0" 
                                    class="active-filter-item" 
                                    :class="{
                                        'not-sortable-item': (isRepositoryLevel || isSelectingFilterType || filter.id == undefined || openedFilterId != '' || choosenMetadatum.name == filter.name || isUpdatingFiltersOrder == true || filterNameFilterString != ''),
                                        'not-focusable-item': openedFilterId == filter.id, 
                                        'disabled-filter': filter.enabled == false,
                                        'inherited-filter': filter.collection_id != collectionId || isRepositoryLevel
                                    }">
                                <div class="handle">
                                    <span
                                            v-if="!isRepositoryLevel"
                                            class="sorting-buttons">
                                        <button 
                                                :disabled="index == 0"
                                                class="link-button"
                                                :aria-label="$i18n.get('label_move_up')"
                                                @click="moveFilterUpViaButton(index)">
                                            <span class="icon">
                                                <i class="tainacan-icon tainacan-icon-previous tainacan-icon-rotate-90" />
                                            </span>
                                        </button>
                                        <button 
                                                :disabled="index == activeFiltersList.length - 1"
                                                class="link-button"
                                                :aria-label="$i18n.get('label_move_down')"
                                                @click="moveFilterDownViaButton(index)">
                                            <span class="icon">
                                                <i class="tainacan-icon tainacan-icon-next tainacan-icon-rotate-90" />
                                            </span>
                                        </button>
                                    </span>
                                    <span 
                                            v-tooltip="{
                                                content: (isSelectingFilterType || filter.id == undefined || openedFilterId != '' || choosenMetadatum.name == filter.name || isUpdatingFiltersOrder == true) ? $i18n.get('info_not_allowed_change_order_filters') : $i18n.get('instruction_drag_and_drop_filter_sort'),
                                                autoHide: true,
                                                popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                placement: 'auto-start'
                                            }"
                                            :style="{ opacity: !(isSelectingFilterType || filter.id == undefined || openedFilterId != '' || choosenMetadatum.name == filter.name || isUpdatingFiltersOrder == true || isRepositoryLevel || filterNameFilterString != '') ? '1.0' : '0.0' }"
                                            class="icon grip-icon">
                                        <svg 
                                                xmlns="http://www.w3.org/2000/svg" 
                                                height="24px"
                                                viewBox="0 0 24 24"
                                                width="24px"
                                                fill="currentColor">
                                            <path
                                                    d="M0 0h24v24H0V0z"
                                                    fill="transparent" />
                                            <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                                        </svg>
                                    </span>
                                    <span 
                                            class="filter-name"
                                            :class="{'is-danger': formWithErrors == filter.id }">
                                        {{ filter.name }}
                                    </span>
                                    <span   
                                            v-if="filter.filter_type_object != undefined"
                                            class="label-details">  
                                        ({{ filter.filter_type_object.name }}) 
                                        <!-- <em v-if="filter.inherited">{{ $i18n.get('label_inherited') }}</em>  -->
                                        <span 
                                                v-if="(editForms[filter.id] != undefined && editForms[filter.id].saved != true) ||filter.status == 'auto-draft'" 
                                                class="not-saved"> 
                                            {{ $i18n.get('info_not_saved') }}
                                        </span>
                                        <span 
                                                v-if="filter.status == 'private'"
                                                v-tooltip="{
                                                    content: $i18n.get('status_private'),
                                                    autoHide: true,
                                                    popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                    placement: 'auto-start'
                                                }"
                                                class="icon">
                                            <i class="tainacan-icon tainacan-icon-private" />
                                        </span>
                                        <span 
                                                v-tooltip="{
                                                    content: filter.collection_id != collectionId ? $i18n.get('label_repository_filter') : $i18n.get('label_collection_filter'),
                                                    autoHide: true,
                                                    popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                    placement: 'auto-start'
                                                }"
                                                class="icon icon-level-identifier">
                                            <i 
                                                    :class="{ 
                                                        'tainacan-icon-collection': filter.collection_id == collectionId, 
                                                        'tainacan-icon-repository': filter.collection_id != collectionId,
                                                        'has-text-turquoise5': filter.enabled && filter.collection_id != 'default', 
                                                        'has-text-blue5': filter.enabled && filter.collection_id == 'default',
                                                        'has-text-gray3': !filter.enabled  
                                                    }"
                                                    class="tainacan-icon" />
                                        </span> 
                                    </span>
                                    <span 
                                            v-if="filter.id == undefined" 
                                            class="loading-spinner" />
                                    <span 
                                            v-if="filter.filter_type != undefined" 
                                            class="controls">
                                        <b-switch
                                                v-if="!isRepositoryLevel"
                                                :disabled="isUpdatingFiltersOrder" 
                                                size="is-small" 
                                                :model-value="filter.enabled" 
                                                @update:model-value="onChangeEnable($event, index)" />
                                        <a 
                                                v-if="filter.current_user_can_edit"
                                                :style="{ visibility: filter.collection_id != collectionId && !isRepositoryLevel? 'hidden' : 'visible' }"
                                                @click.prevent="toggleFilterEdition(filter.id)">
                                            <span 
                                                    v-tooltip="{
                                                        content: $i18n.get('edit'),
                                                        autoHide: true,
                                                        popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                        placement: 'bottom'
                                                    }"
                                                    class="icon">
                                                <i class="tainacan-icon tainacan-icon-1-25em tainacan-icon-edit" />
                                            </span>
                                        </a>
                                        <a 
                                                v-if="filter.current_user_can_delete"
                                                :style="{ visibility: (filter.collection_id != collectionId && !isRepositoryLevel) || (filter.id == openedFilterId) ? 'hidden' : 'visible' }"
                                                @click.prevent="removeFilter(filter)">
                                            <span
                                                    v-tooltip="{
                                                        content: $i18n.get('delete'),
                                                        autoHide: true,
                                                        popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                        placement: 'bottom'
                                                    }"
                                                    class="icon">
                                                <i class="tainacan-icon tainacan-icon-1-25em tainacan-icon-delete" />
                                            </span>
                                        </a>
                                    </span>
                                </div>
                                <transition name="form-collapse">
                                    <b-field v-if="openedFilterId == filter.id">
                                        <filter-edition-form
                                                :is-repository-level="isRepositoryLevel"
                                                :index="index"
                                                :original-filter="filter"
                                                :edited-filter="editForms[openedFilterId]"
                                                @on-edition-finished="onEditionFinished()"
                                                @on-edition-canceled="onEditionCanceled()"
                                                @on-error-found="formWithErrors = filter.id"
                                                @on-update-saved-state="(state) => editForms[filter.id].saved = state" />
                                    </b-field>
                                </transition>
                            </div>
                        </template>
                    </sortable>
                </div>
                <div 
                        v-if="(isRepositoryLevel && $userCaps.hasCapability('tnc_rep_edit_filters') || !isRepositoryLevel)"
                        class="column available-metadata-area is-12-touch">
                    <div class="tainacan-form sub-header">
                        <h2>{{ $i18n.get('label_available_metadata') }}</h2>

                        <template v-if="availableMetadata && availableMetadata.length > 5 && !isLoadingMetadatumTypes">
                                
                            <b-field class="header-item">
                                <b-input 
                                        v-model="metadatumNameFilterString"
                                        :placeholder="$i18n.get('instruction_type_search_metadata_filter')"
                                        icon="magnify"
                                        size="is-small"
                                        icon-right="close-circle"
                                        icon-right-clickable
                                        @icon-right-click="metadatumNameFilterString = ''" />
                            </b-field>
                        </template>
                    </div>
                    <div class="field">
                        
                        <sortable
                                v-if="availableMetadata.length > 0 && !isLoadingMetadatumTypes"
                                :list="availableMetadata"
                                item-key="id"
                                :options="{
                                    group: {
                                        name:'filters',
                                        pull: !isSelectingFilterType, 
                                        put: false, revertClone: true
                                    },
                                    sort: false,
                                    filter: '.not-sortable-item',
                                    preventOnFilter: false,
                                    dragClass: 'sortable-drag'
                                }"
                                @change="handleChangeOnMetadata">
                            <template #item="{ element: metadatum, index }">
                                <div 
                                        v-if="metadatum.enabled"
                                        v-show="metadatumNameFilterString == '' || metadatum.name.toString().toLowerCase().indexOf(metadatumNameFilterString.toString().toLowerCase()) >= 0"
                                        class="available-metadatum-item"
                                        :class="{
                                            'inherited-metadatum': metadatum.inherited || isRepositoryLevel,
                                            'disabled-metadatum': isSelectingFilterType
                                        }"
                                        @click.prevent="addMetadatumViaButton(metadatum, index)">
                                    <span 
                                            v-tooltip="{
                                                content: $i18n.get('instruction_click_or_drag_filter_create'),
                                                autoHide: true,
                                                popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                placement: 'auto-start'
                                            }" 
                                            class="icon grip-icon">
                                        <!-- <i class="tainacan-icon tainacan-icon-1-25em tainacan-icon-drag"/> -->
                                        <svg 
                                                xmlns="http://www.w3.org/2000/svg" 
                                                height="24px"
                                                viewBox="0 0 24 24"
                                                width="24px"
                                                fill="currentColor">
                                            <path
                                                    d="M0 0h24v24H0V0z"
                                                    fill="transparent" />
                                            <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                                        </svg>
                                    </span> 
                                    <span 
                                            v-tooltip="{
                                                content: metadatum.name + (metadatum.parent_name ? (' (' + $i18n.get('info_child_of') + ' ' + metadatum.parent_name + ')') : ''),
                                                autoHide: true,
                                                popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                placement: 'auto-start'
                                            }"
                                            class="metadatum-name">
                                        {{ metadatum.name }}
                                        <span   
                                                v-if="metadatum.parent_name"
                                                class="label-details"
                                                style="font-size: 0.875em;"> 
                                            <em>{{ '(' + $i18n.get('info_child_of') + ' ' + metadatum.parent_name + ')' }}</em>
                                        </span>
                                        <span 
                                                v-if="metadatum.status === 'private'"
                                                v-tooltip="{
                                                    content: $i18n.get('status_private'),
                                                    autoHide: true,
                                                    popperClass: ['tainacan-tooltip', 'tooltip'],
                                                    placement: 'auto-start'
                                                }"
                                                class="icon">
                                            <i class="tainacan-icon tainacan-icon-private" />
                                        </span>
                                    </span>
                                    <span 
                                            v-tooltip="{
                                                content: isRepositoryLevel || metadatum.collection_id != collectionId ? $i18n.get('label_repository_filter') : $i18n.get('label_collection_filter'),
                                                autoHide: true,
                                                popperClass: ['tainacan-tooltip', 'tooltip', isRepositoryLevel ? 'tainacan-repository-tooltip' : ''],
                                                placement: 'auto-start'
                                            }"
                                            class="icon icon-level-identifier">
                                        <i 
                                                :class="{   
                                                    'tainacan-icon-collection has-text-turquoise5': metadatum.collection_id == collectionId && !isRepositoryLevel, 
                                                    'tainacan-icon-repository has-text-blue5': isRepositoryLevel || metadatum.collection_id != collectionId 
                                                }"
                                                class="tainacan-icon" />
                                    </span> 
                                </div>
                            </template>
                        </sortable>   
                    
                        <section 
                                v-if="availableMetadata.length <= 0 && !isLoadingMetadatumTypes"
                                class="field is-grouped-centered section">
                            <div class="content has-text-gray has-text-centered">
                                <p>
                                    <span class="icon is-large">
                                        <i class="tainacan-icon tainacan-icon-36px tainacan-icon-metadata" />
                                    </span>
                                </p>
                                <p>{{ $i18n.get('info_there_is_no_metadatum' ) }}</p>
                                <router-link
                                        v-slot="{ navigate }"
                                        :to="isRepositoryLevel ? $routerHelper.getNewMetadatumPath() : $routerHelper.getNewCollectionMetadatumPath(collectionId)"
                                        custom>
                                    <button
                                            id="button-create-metadatum" 
                                            role="link"
                                            ttype="button" 
                                            class="button is-secondary is-centered"
                                            @click="navigate()">
                                        {{ $i18n.getFrom('metadata', 'new_item') }}
                                    </button>
                                </router-link>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <section 
                    v-else
                    class="section">
                <div class="content has-text-grey has-text-centered">
                    <p>
                        <span class="icon">
                            <i class="tainacan-icon tainacan-icon-30px tainacan-icon-filters" />
                        </span>
                    </p>
                    <p>{{ $i18n.get('info_can_not_edit_filters') }}</p>
                </div>
            </section>

            <b-modal 
                    ref="filterTypeModal"
                    v-model="isSelectingFilterType"
                    :width="680"
                    trap-focus
                    aria-modal
                    aria-role="dialog"
                    custom-class="tainacan-modal"
                    :can-cancel="['escape', 'outside']"
                    :close-button-aria-label="$i18n.get('close')">
                <div 
                        autofocus
                        role="dialog"
                        tabindex="-1"
                        aria-modal
                        class="tainacan-modal-content" 
                        style="width: auto">
                    <header class="tainacan-modal-title">
                        <h2>{{ $i18n.get('label_available_filter_types') }}</h2>
                    </header>
                    <section class="tainacan-form">
                        <form class="tainacan-form">
                            <div class="columns">
                                <div class="column">
                                    <div 
                                            role="list"
                                            class="filter-types-container">
                                        <p>{{ $i18n.get('instruction_click_to_select_a_filter_type') }}</p>
                                        <br>
                                        <div
                                                v-for="(filterType, index) in allowedFilterTypes"
                                                :key="index"
                                                role="listitem"
                                                class="filter-type"
                                                @click="onFilterTypeSelected(filterType)"
                                                @mouseover="currentFilterTypePreview = { name: filterType.name, template: filterType.preview_template }"
                                                @mouseleave="currentFilterTypePreview = { name: filterType.name, template: filterType.preview_template }">
                                            <h4>{{ filterType.name }}</h4>          
                                        </div>
                                    </div>
                                </div>
                                <div class="column">
                                    <div 
                                            :style="{ 'min-height': getProperPreviewMinHeight() + 'px'}"
                                            class="filter-type-preview">
                                        <span class="filter-type-label">{{ $i18n.get('label_filter_type_preview') }}</span>
                                        <div 
                                                v-if="currentFilterTypePreview != undefined && currentFilterTypePreview.template != ''"
                                                class="field">
                                            <span class="collapse-handle">
                                                <span class="icon">
                                                    <i class="has-text-secondary tainacan-icon tainacan-icon-1-25em tainacan-icon-arrowdown" />
                                                </span> 
                                                <label class="label has-tooltip">
                                                    {{ currentFilterTypePreview.name }}
                                                </label>
                                            </span>
                                            <div v-html="currentFilterTypePreview.template" />
                                        </div>
                                        <span 
                                                v-else
                                                class="has-text-gray">
                                            {{ $i18n.get('instruction_hover_a_filter_type_to_preview') }}
                                        </span>
                                    </div>
                                </div>                        
                            </div>
                        </form>

                        <footer class="field is-grouped form-submit">
                            <div class="control">
                                <button 
                                        class="button is-outlined" 
                                        type="button" 
                                        @click="onCancelFilterTypeSelection()">{{ $i18n.get('cancel') }}</button>
                            </div>
                        </footer>
                    </section>
                </div>
            </b-modal>
        </div>
    </div>
</template>

<script>
import { nextTick } from 'vue';
import { mapActions, mapGetters } from 'vuex';

import FilterEditionForm from '../../components/edition/filter-edition-form.vue';
import CustomDialog from '../../components/other/custom-dialog.vue';
import { Sortable } from "sortablejs-vue3";

export default {
    name: 'FiltersPage',
    components: {
        FilterEditionForm,
        Sortable
    },
    beforeRouteLeave ( to, from, next ) {
        let hasUnsavedForms = false;
        for (let editForm in this.editForms) {
            if (!this.editForms[editForm].saved) 
                hasUnsavedForms = true;
        }
        if ((this.openedFilterId != '' && this.openedFilterId != undefined) || hasUnsavedForms ) {
            this.$buefy.modal.open({
                parent: this,
                component: CustomDialog,
                props: {
                    icon: 'alert',
                    title: this.$i18n.get('label_warning'),
                    message: this.$i18n.get('info_warning_filters_not_saved'),
                    onConfirm: () => {
                        this.onEditionCanceled();
                        next();
                    },
                },
                trapFocus: true,
                customClass: 'tainacan-modal',
                canCancel: ['escape', 'outside']
            });  
        } else {
            next()
        }  
    },
    data(){
        return {
            isRepositoryLevel: false,
            collectionId: '',
            isDraggingFromAvailable: false,
            isLoadingMetadatumTypes: true,
            isLoadingFilters: false,
            isLoadingFilterTypes: false,
            isLoadingFilter: false,
            isSelectingFilterType: false,
            isUpdatingFiltersOrder: false,
            openedFilterId: '',
            formWithErrors: '',
            editForms: {},
            allowedFilterTypes: [], 
            selectedFilterType: {},
            choosenMetadatum: {},
            newFilterIndex: 0,
            availableMetadata: [],
            filterTypes: [],
            currentFilterTypePreview: undefined,
            columnsTopY: 0,
            filtersSearchCancel: undefined,
            metadataSearchCancel: undefined,
            filterNameFilterString: '',
            metadatumNameFilterString: ''
        }
    },
    computed: {
        ...mapGetters('collection', {
            'collection': 'getCollection',
        }),
        activeFiltersList: {
            get() {
                return this.getFilters();
            },
            set(value) {
                this.updateFilters(value);
            }
        },
    },
    watch: {
        '$route.query': {
            handler(newQuery) {
                if (newQuery.edit != undefined) {
                    let existingFilterIndex = this.activeFiltersList.findIndex((filter) => filter.id == newQuery.edit);
                    if (existingFilterIndex >= 0)
                        this.editFilter(this.activeFiltersList[existingFilterIndex])                        
                }
            },
            immediate: true,
            deep: true
        }
    },
    created() {
        this.isRepositoryLevel = (this.$route.params.collectionId === undefined);
    },
    mounted() {
        nextTick(() => { 
            this.columnsTopY = this.$refs.filterEditionPageColumns ? this.$refs.filterEditionPageColumns.getBoundingClientRect().top : 0;
        });

        if (this.isRepositoryLevel)
            this.collectionId = 'default';
        else {
            this.collectionId = this.$route.params.collectionId;
        }

        this.isLoadingFilterTypes = true;

        this.fetchFilterTypes()
            .then((filterTypes) => {
                this.isLoadingFilterTypes = false;
                this.filterTypes = filterTypes;
            })
            .catch(() => {
                this.isLoadingFilterTypes = false;
            });        

        // Cancels previous Request
        if (this.filtersSearchCancel != undefined)
            this.filtersSearchCancel.cancel('Filters search Canceled.');

        // Loads Filters
        this.refreshFilters();
        
        // Sets modal callback function
        this.$refs.filterTypeModal.onCancel = () => {
            this.onCancelFilterTypeSelection();
        }
        
    },
    beforeUnmount() {
        // Cancels previous filters Request
        if (this.filtersSearchCancel != undefined)
            this.filtersSearchCancel.cancel('Metadata search Canceled.');
        
        // Cancels previous metadata Request
        if (this.metadataSearchCancel != undefined)
            this.metadataSearchCancel.cancel('Metadata search Canceled.');
    },
    methods: {
        ...mapActions('filter', [
            'fetchFilterTypes',
            'fetchFilters',
            'sendFilter',
            'deleteFilter',
            'updateFilters',
            'updateCollectionFiltersOrder',
            'moveFilterUp',
            'moveFilterDown'
        ]),
        ...mapGetters('filter',[
            'getFilters'
        ]),
        ...mapActions('metadata', [
            'fetchMetadata',
        ]),
        ...mapGetters('metadata', [
            'getMetadata',
        ]),
        handleChangeOnFilter($event) {
            switch( $event.type ) {
                case 'add':
                    this.prepareFilterTypeSelection(this.availableMetadata[$event.oldIndex], $event.newIndex);
                    break;
                case 'remove':
                    this.removeFilter(this.activeFiltersList[$event.oldIndex]);
                    break;
                case 'change':
                case 'update': {
                    const newActiveFiltersList = JSON.parse(JSON.stringify(this.activeFiltersList));
                    const element = newActiveFiltersList.splice($event.oldIndex, 1)[0];
                    newActiveFiltersList.splice($event.newIndex, 0, element);
                    
                    this.updateFilters(newActiveFiltersList);
                    
                    if (!this.isRepositoryLevel)
                        this.updateFiltersOrder();

                    break;
                }
            }
        },
        prepareFilterTypeSelection(choosenMetadatum, newFilterIndex) {
            this.choosenMetadatum = choosenMetadatum;
            this.newFilterIndex = newFilterIndex;

            this.allowedFilterTypes = [];
            this.selectedFilterType = {};
            for (let filter of this.filterTypes) {
                for (let supportedType of filter['supported_types']) {
                    if (choosenMetadatum.metadata_type_object.primitive_type == supportedType)
                        this.allowedFilterTypes.push(filter);
                }
            }

            this.isSelectingFilterType = true;
        },
        addMetadatumViaButton(metadatum, metadatumIndex) {
            
            this.oldMetadatumIndex = metadatumIndex;

            // Removes element from metadata list, as from button this does not happens
            this.availableMetadata.splice(metadatumIndex, 1);
            
            // Inserts it at the end of the list
            let lastFilterIndex = this.activeFiltersList.length;
            // // Updates store with temporary Filter
            // this.addTemporaryFilter(metadatumType);

            this.prepareFilterTypeSelection(metadatum, lastFilterIndex);
        
        },
        onFilterTypeSelected(filterType) {
            this.isSelectingFilterType = false;
            this.allowedFilterTypes = [];
            this.currentFilterTypePreview = undefined;

            this.selectedFilterType = filterType;
            this.createChoosenFilter();
        },
        onCancelFilterTypeSelection() {
            this.isSelectingFilterType = false;
            this.allowedFilterTypes = [];
            this.currentFilterTypePreview = undefined;
            this.selectedFilterType = {};

            // Puts element back to metadata list
            this.availableMetadata.splice(this.oldMetadatumIndex, 0, this.choosenMetadatum)
            this.choosenMetadatum = {};

            // Removes element from filters list
            this.activeFiltersList.splice(this.newFilterIndex, 1);
        },
        handleChangeOnMetadata($event) {
            if ( $event.type == 'removed' )
                this.oldMetadatumIndex = $event.removed.oldIndex;
        },
        updateFiltersOrder() {
            let filtersOrder = [];
            for (let filter of this.activeFiltersList) {
                filtersOrder.push({'id': filter.id, 'enabled': filter.enabled});
            }
            this.isUpdatingFiltersOrder = true;
            this.updateCollectionFiltersOrder({ collectionId: this.collectionId, filtersOrder: filtersOrder })
                .then(() => { this.isUpdatingFiltersOrder = false; })
                .catch(() => { this.isUpdatingFiltersOrder = false });
        },
        updateListOfMetadata() {
            const availableMetadata = JSON.parse(JSON.stringify(this.getMetadata()));

            const availableMetadataNames = {};
            let lastParentName = '';

            for (let availableMetadatum of availableMetadata)
                availableMetadataNames['' + availableMetadatum.id] = availableMetadatum.name;
            
            for (let availableMetadatum of availableMetadata) {
                if (availableMetadatum.parent > 0 && availableMetadataNames[availableMetadatum.parent]) {
                    availableMetadatum.parent_name = availableMetadataNames[availableMetadatum.parent];
                    
                    if (lastParentName !== availableMetadatum.parent_name)
                        availableMetadatum.first_child = true;

                    lastParentName = availableMetadatum.parent_name;   
                }
            }
           
            for (let activeFilter of this.activeFiltersList) {
                for (let i = availableMetadata.length - 1; i >= 0 ; i--) {
                    if (activeFilter.metadatum != undefined) {
                        if (activeFilter.metadatum.metadatum_id == availableMetadata[i].id)
                            availableMetadata.splice(i, 1);
                    }
                }
            }

            this.availableMetadata = availableMetadata.filter((aMetadatum) => aMetadatum.metadata_type_object.component != 'tainacan-compound' && aMetadatum.metadata_type_object.component != 'tainacan-geocoordinate');
        },  
        onChangeEnable($event, index) {
            let filtersOrder = [];
            for (let filter of this.activeFiltersList) {
                filtersOrder.push({'id': filter.id, 'enabled': filter.enabled});
            }
            filtersOrder[index].enabled = $event;
            this.isUpdatingFiltersOrder = true;
            this.updateCollectionFiltersOrder({ collectionId: this.collectionId, filtersOrder: filtersOrder })
                .then(() => { this.isUpdatingFiltersOrder = false; })
                .catch(() => { this.isUpdatingFiltersOrder = false; });
        },
        createChoosenFilter() {
            this.sendFilter({
                collectionId: this.collectionId, 
                metadatumId: this.choosenMetadatum.id,
                name: this.choosenMetadatum.parent_name ? this.choosenMetadatum.name + ' (' + this.choosenMetadatum.parent_name + ')' : this.choosenMetadatum.name,
                filterType: this.selectedFilterType.className,
                status: 'auto-draft', 
                isRepositoryLevel: this.isRepositoryLevel,
                newIndex: this.newFilterIndex
            })
            .then((filter) => {

                if ( !this.isRepositoryLevel )
                    this.updateFiltersOrder();

                this.newFilterIndex = 0;
                this.choosenMetadatum = {};
                this.selectedFilterType = {}
                this.allowedFilterTypes = [];

                this.toggleFilterEdition(filter.id);
            })
            .catch((error) => {
                this.$console.error(error);
                this.newFilterIndex = 0;
                this.choosenMetadatum = {};
                this.selectedFilterType = {}
                this.allowedFilterTypes = [];
            });
        },
        removeFilter(removedFilter) {

            if (this.editForms[removedFilter.id])
                delete this.editForms[removedFilter.id];

            this.deleteFilter(removedFilter.id)
                .then(() => {
                    // Reload Available Metadatum Types List
                    this.updateListOfMetadata();
                })
                .catch((error) => { this.$console.log(error)});
        
            if (!this.isRepositoryLevel)
                this.updateFiltersOrder(); 
        },
        confirmSelectedFilterType() {
            this.isSelectingFilterType = false;
            this.createChoosenFilter();
        },
        cancelFilterTypeSelection() {
            this.isSelectingFilterType = false;
            this.availableMetadata.push(this.choosenMetadatum);
            this.choosenMetadatum = {};
            this.allowedFilterTypes = [];
            this.selectedFilterType = {};
            // this.deleteTemporaryFilter(this.newFilterIndex);
            this.newFilterIndex = 0;
        },
        toggleFilterEdition(filterId) {
            // Closing collapse
            if ( this.openedFilterId == filterId ) {
                this.openedFilterId = '';
                this.$router.push({ query: {}});

            // Opening collapse
            } else {
                this.$router.push({ query: { edit: filterId}})
            }
        },
        editFilter(filter) {
            this.openedFilterId = filter.id;

            // First time opening
            if (this.editForms[this.openedFilterId] == undefined) {
                this.editForms[this.openedFilterId] = JSON.parse(JSON.stringify(filter));
                this.editForms[this.openedFilterId].saved = true;
                
                // Filter inserted now
                if (this.editForms[this.openedFilterId].status == 'auto-draft') {
                    this.editForms[this.openedFilterId].status = 'publish'; 
                    this.editForms[this.openedFilterId].saved = false;
                }
            }      
        },
        onEditionFinished() {
            this.formWithErrors = '';
            this.openedFilterId = '';
            this.$router.push({ query: {}});
        },
        onEditionCanceled() {
            this.formWithErrors = '';
            this.openedFilterId = '';
            this.$router.push({ query: {}});
        },
        moveFilterUpViaButton(index) {
            this.moveFilterUp(index)
            this.updateFiltersOrder();
        },
        moveFilterDownViaButton(index) {
            this.moveFilterDown(index);
            this.updateFiltersOrder();
        },
        getProperPreviewMinHeight() {
            for (let filterType of this.allowedFilterTypes) {
                if (filterType.component == 'tainacan-filter-taginput' || 
                    filterType.component == 'tainacan-filter-checkbox' || 
                    filterType.component == 'tainacan-filter-taxonomy-taginput' || 
                    filterType.component == 'tainacan-filter-taxonomy-checkbox') {
                    return 330;
                }
            }
            return 190;
        },
        refreshFilters() {
            this.isLoadingFilters = true;
            this.fetchFilters({
                collectionId: this.collectionId,
                isRepositoryLevel: this.isRepositoryLevel,
                isContextEdit: !this.isOnTheme,
                includeDisabled: true,
            }).then((resp) => {
                resp.request
                    .then(() => {
                        
                        this.isLoadingFilters = false;
                        this.isLoadingMetadatumTypes = true;

                        // Checks URL as router watcher would not wait for list to load
                        if (this.$route.query.edit != undefined) {
                            let existingFilterIndex = this.activeFiltersList.findIndex((filter) => filter.id == this.$route.query.edit);
                            if (existingFilterIndex >= 0)
                                this.editFilter(this.activeFiltersList[existingFilterIndex]);                        
                        }

                        // Cancels previous Request
                        if (this.metadataSearchCancel != undefined)
                            this.metadataSearchCancel.cancel('Metadata search Canceled.');

                        // Needs to be done after activeFiltersList exists to compare and remove chosen metadata.
                        this.fetchMetadata({
                            collectionId: this.collectionId, 
                            isRepositoryLevel: this.isRepositoryLevel, 
                            isContextEdit: true,
                            parent: 'any',
                            includeControlMetadataTypes: true,
                        }).then((resp) => {
                                resp.request
                                    .then(() => {
                                        this.isLoadingMetadatumTypes = false;
                                        this.updateListOfMetadata();
                                    })
                                    .catch(() => {
                                        this.isLoadingMetadatumTypes = false;
                                    });
                                // Search Request Token for cancelling
                            this.metadataSearchCancel = resp.source;
                        })
                        .catch(() => this.isLoadingMetadatumTypes = false);  
                    })
                    .catch(() => this.isLoadingFilters = false);

                // Search Request Token for cancelling
                this.filtersSearchCancel = resp.source;
            })
            .catch(() => this.isLoadingFilters = false);
        }
    }
}
</script>

<style lang="scss">

    .filters-list-page {
        padding-bottom: 0;
           
        .column {
            overflow-x: hidden;
            overflow-y: auto;
            padding: 0.75em 0;

            &>section.field {
                position: absolute;
            }

            &:not(.available-metadata-area){
                margin-right: 30px;
                flex-grow: 2;

                @media screen and (max-width: 1023px) {
                    margin-right: 0;
                }
            }
            h2,
            h3 {
                font-weight: 500;
            }
        }

        .sub-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5em 1em 0.5em 0.5em;

            .header-item {
                margin-left: 0.75rem;
                margin-bottom: 0px;
            }

            h2,
            h3 {
                margin-right: auto;
            }
        }

        .loading-spinner {
            animation: spinAround 500ms infinite linear;
            border: 2px solid var(--tainacan-gray2);
            border-radius: 290486px;
            border-right-color: transparent;
            border-top-color: transparent;
            content: "";
            display: inline-block;
            height: 1em; 
            width: 1em;
        }

        .active-filters-area {
            font-size: 0.875em;
            margin-left: 1.5em;
            padding-right: 1em;
            padding-top: 1em;
            min-height: 330px;

            @media screen and (max-width: 1024px) {
                min-height: 45px;
                margin: 0; 
                padding-right: 0em;
            }
            @media screen and (max-width: 1216px) {
                padding-right: 1em;
            }

            &.filters-area-receive {
                border: 1px dashed var(--tainacan-gray4);
            }

            .collapse {
                display: initial;
            }

            .active-filter-item {
                background-color: var(--tainacan-white);
                padding: 0.7em 0.9em;
                margin: 4px;
                min-height: 2.8571em;
                position: relative;
                display: block; 
                transition: top 0.1s ease;
                cursor: grab;
                border-radius: var(--tainacan-button-border-radius, 3px);

                form.tainacan-form {
                    padding: 1.0em 2.0em;
                    margin-top: 1.0em;
                    border-top: 1px solid var(--tainacan-gray2);
                    border-bottom: 1px solid var(--tainacan-gray2);
                }
            
                &>.field, form {
                    background-color: var(--tainacan-white) !important;
                }

                .sorting-buttons {
                    display: flex;
                    flex-direction: column;
                    position: absolute;
                    overflow: hidden;
                    border-top-right-radius: 0;
                    border-bottom-right-radius: 0;
                    border-top-left-radius: var(--tainacan-button-border-radius, 3px);
                    border-bottom-left-radius: var(--tainacan-button-border-radius, 3px);
                    font-size: 0.875em;
                    left: 0em; 
                    top: 0px;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.2s ease, left 0.2s ease;

                    button {
                        border: none;
                        background: var(--tainacan-turquoise1);
                        &:hover {
                            color: var(--tainacan-secondary);
                        }
                    }
                }
                &:not(.not-sortable-item):hover {
                    .sorting-buttons {
                        opacity: 1.0;
                        visibility: visible;
                        left: -2em
                    }
                }
                .handle {
                    padding-right: 6em;
                    border-radius: var(--tainacan-button-border-radius, 0px);
                    white-space: nowrap;
                    display: flex;
                }
                .grip-icon { 
                    color: var(--tainacan-gray3);
                    position: relative;
                    flex-shrink: 0;
                }
                .filter-name {
                    text-overflow: ellipsis;
                    overflow-x: hidden;
                    white-space: nowrap;
                    font-weight: bold;
                    margin-left: 0.4em;
                    margin-right: 0.4em;

                    &.is-danger {
                        color: var(--tainacan-danger) !important;
                    }
                }
                .label-details {
                    font-weight: normal;
                    color: var(--tainacan-gray3);
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    overflow: hidden;
                    -webkit-touch-callout: none;
                    -webkit-user-select: none;
                    -khtml-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                    user-select: none;
                }
                .not-saved {
                    font-style: italic;
                    font-weight: bold;
                    color: var(--tainacan-danger);
                    margin-left: 0.5em;
                }
                .controls { 
                    font-size: 0.875em;
                    position: absolute;
                    right: 11px;
                    top: 11px;
                    display: flex;
                    align-items: center;

                   .icon {
                        width: 2em;
                        i, i:before { font-size: 1.25em; }
                    }
                }

                &.not-sortable-item,
                &.not-sortable-item:hover {
                    cursor: default;
                    background-color: var(--tainacan-white) !important;
                } 
                &.not-focusable-item,
                &.not-focusable-item:hover {
                    cursor: default;
                
                    .metadatum-name {
                        color: var(--tainacan-secondary);
                    }
                }
                &.disabled-filter:not(.not-sortable-item),
                &.disabled-filter:not(.not-sortable-item):hover {
                    color: var(--tainacan-gray3);
                    .label-details, .not-saved {
                        color: var(--tainacan-gray3) !important;
                    }
                }    
            }
            .active-filter-item:not(:hover) .icon-level-identifier .tainacan-icon::before,
            .active-filter-item:hover.not-sortable-item .icon-level-identifier .tainacan-icon::before {
                color: var(--tainacan-gray3) !important;
            }
            .active-filter-item:hover:not(.not-sortable-item) {
                background-color: var(--tainacan-turquoise1);
                border-color: var(--tainacan-turquoise1);

                .label-details, .not-saved {
                    color: var(--tainacan-gray4) !important;
                }
                .grip-icon { 
                    color: var(--tainacan-secondary);
                }

            }
            .available-metadatum-item:not(.sortable-ghost):not(.disabled-metadatum) {
                display: none;
                visibility: hidden;
            }
            .sortable-ghost {
                border: 1px dashed var(--tainacan-gray2);
                background: var(--tainacan-white);
                display: block;
                padding: 0.7em 0.9em;
                margin: 4px;
                height: 2.8571em;
                position: relative;

                .grip-icon { 
                    color: var(--tainacan-white); 
                }
            }
        }

        .available-metadata-area {
            padding: 0px 0px 10px 10px;
            margin: 0;
            max-width: 600px;
            min-width: 41.66666667%;

            @media screen and (max-width: 1023px) {
                max-width: 100%;
                padding: 10px;

                h2,
                h3 {
                    margin: 1em 0em 1em 0em !important;
                }
                .available-metadatum-item::before,
                .available-metadatum-item::after {
                    display: none !important;
                }
            }

            h2,
            h3 {
                margin: 0.875em 0em 1em 0em;
                font-weight: 500;
            }

            &>.field {
                font-size: 0.875em;
                padding-right: 1em;
                padding-left: 1em;
            }

            .available-metadatum-item {
                padding: 0.6em;
                margin: 4px 4px 4px 1.2em;
                background-color: var(--tainacan-white);
                cursor: pointer;
                left: 0;
                height: 2.8571em;
                position: relative;
                border: 1px solid var(--tainacan-gray2);
                border-radius: var(--tainacan-button-border-radius, 0px);
                transition: left 0.2s ease;
                
                .grip-icon { 
                    color: var(--tainacan-gray3);
                    position: relative;
                    flex-shrink: 0;
                }
                .icon-level-identifier {
                    position: relative;
                    bottom: 6px;
                }
                .metadatum-name {
                    text-overflow: ellipsis;
                    overflow-x: hidden;
                    white-space: nowrap;
                    font-weight: bold;
                    margin-left: 0.4em;
                    display: inline-block;
                    width: calc(100% - 60px);
                }
                &:after,
                &:before {
                    content: '';
                    display: block;
                    position: absolute;
                    right: 100%;
                    width: 0;
                    height: 0;
                    border-style: solid;
                    border-radius: var(--tainacan-button-border-radius, 0px);
                }
                &:after {
                    top: -1px;
                    border-color: transparent white transparent transparent;
                    border-right-width: 16px;
                    border-top-width: 1.4286em;
                    border-bottom-width: 1.4286em;
                    left: calc( -19px + (var(--tainacan-button-border-radius, 0px) / 2));
                }
                &:before {
                    top: -1px;
                    border-color: transparent var(--tainacan-gray2) transparent transparent;
                    border-right-width: 16px;
                    border-top-width: 1.4286em;
                    border-bottom-width: 1.4286em;
                    left: calc( -20px + (var(--tainacan-button-border-radius, 0px) / 2));
                }
                .label-details {
                    font-weight: normal;
                    color: var(--tainacan-gray3);
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    overflow: hidden;
                }
            }
            .sortable-drag {
                opacity: 1 !important;
            }

            .compound-metadatum-label {
                font-weight: bold;
                color: var(--tainacan-gray3);
                padding: 20px;
                position: relative;
                top: 2px;
            }
            .available-metadatum-item:not(:hover) .icon-level-identifier .tainacan-icon::before,
            .available-filter-item:hover.not-sortable-item .icon-level-identifier .tainacan-icon::before {
                color: var(--tainacan-gray3) !important;
            }
            .available-metadatum-item:not(.disabled-metadatum):hover{
                background-color: var(--tainacan-turquoise1);
                border-color: var(--tainacan-turquoise2);
                position: relative;
                left: -4px;

                &:after {
                    border-color: transparent var(--tainacan-turquoise1) transparent transparent;
                }
                &:before {
                    border-color: transparent var(--tainacan-turquoise2) transparent transparent;
                }
                .grip-icon {
                    color: var(--tainacan-secondary) !important;
                }
            }
        }

        .inherited-filter {
            &.active-filter-item:hover:not(.not-sortable-item) {
                background-color: var(--tainacan-blue1);
                border-color: var(--tainacan-blue2);
                
                .grip-icon { 
                    color: var(--tainacan-blue5) !important; 
                }
            }
            .sorting-buttons button {
                background: var(--tainacan-blue1);
                &:hover {
                    color: var(--tainacan-blue5);
                }
            }
        }
        .inherited-metadatum {
            .switch.is-small input[type="checkbox"]:checked + .check {
                border: 1.5px solid var(--tainacan-blue5);
                &::before { background-color: var(--tainacan-blue5); }
            }
            &.available-metadatum-item:not(.disabled-metadatum):hover {
                background-color: var(--tainacan-blue1) !important;
                border-color: var(--tainacan-blue2) !important;
            
                .grip-icon { 
                    color: var(--tainacan-blue5) !important; 
                }
                &:after {
                    border-color: transparent var(--tainacan-blue1) transparent transparent !important;
                }
                &:before {
                    border-color: transparent var(--tainacan-blue2) transparent transparent !important;
                }

            }
        }
        .child-metadatum {
            margin-left: 42px !important;
        }
        .tainacan-modal-content {

            .column {
                overflow: visible;
                margin: 0;
            }

            .filter-types-container {
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;

                p { margin-bottom: 16px; }

                .filter-type {
                    border-bottom: 1px solid var(--tainacan-gray2);
                    padding: 15px 8.3333333%;
                    cursor: pointer;
                
                    &:first-child {
                        margin-top: 15px;
                    }
                    &:last-child {
                        border-bottom: none;
                    }
                    &:hover {
                        background-color: var(--tainacan-gray2);
                    }
                }
            }

            .filter-type-preview {
                background: var(--tainacan-gray1);
                margin: 12px auto;
                padding: 12px 30px;
                border-radius: 3px;
                z-index: 9999999999999;
                width: 218px;
                display: flex;
                align-items: center;
                justify-content: center;
                pointer-events: none;
                cursor: none;
                flex-wrap: wrap;
                max-width: 260px;
                width: 100%;
                height: 100%;
                min-height: 290px;
                align-items: normal;

                @media screen and (max-width: 1023px) {
                    max-width: 100%;
                }

                .filter-type-label {
                    font-weight: 600;
                    color: var(--tainacan-info-color);
                    width: 100%;
                    font-size: 1em;
                    margin-left: -16px;
                }
                
                .field .collapse-handle {
                    display: flex;
                }

                input, select, textarea, 
                .input, .tags, .tag  {
                    pointer-events: none;
                    cursor: none;
                    background-color: rgba(255,255,255,0.60) !important;
                }
                .autocomplete>.control, .autocomplete>.control>input, .dropdown-content {
                    background-color: var(--tainacan-gray0) !important;
                }
                .taginput {
                    margin-bottom: 80px;
                }
                input[type="checkbox"]:checked + .check {
                    background: rgba(255,255,255,0.60) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3Cpath style='fill:rgb(69,70,71)' d='M 0.04038059,0.6267767 0.14644661,0.52071068 0.42928932,0.80355339 0.3232233,0.90961941 z M 0.21715729,0.80355339 0.85355339,0.16715729 0.95961941,0.2732233 0.3232233,0.90961941 z'%3E%3C/path%3E%3C/svg%3E") no-repeat center center !important
                }
                textarea {
                    min-height: 70px;
                }
                .field {
                    width: 100%;
                    margin: 6px;
                    .label { 
                        color: var(--tainacan-label-color);
                        font-weight: normal;
                    }
                }
                .add-new-term {
                    font-size: 0.75em;
                    text-decoration: underline;
                    margin: 0.875em 1.5em;
                }

                .numeric-filter-container,
                .date-filter-container {
                    display: flex;

                    .field { margin: 0; }
                    .dropdown {
                        width: auto;

                        .dropdown-trigger button {
                            padding: 0 0.5em !important;
                            height: auto !important;

                            i:not(.tainacan-icon-arrowdown) {
                                margin-top: -3px;
                                font-size: 1.5em;
                                font-style: normal;
                                color: var(--tainacan-info-color);
                            }
                        }
                        .dropdown-menu {
                            display: block !important;
                        }
                    }
                    .datepicker {
                        flex-shrink: 0;
                        max-width: 70%;
                    }
                }

            }

        }
    }
    .tainacan-repository-level-colors {
        .tainacan-form.sub-header {
            padding-left: 0 !important;
        }
        .filters-list-page .active-filters-area {
            margin-left: 0 !important;
        }
    }
</style>
